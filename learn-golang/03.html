<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Go 快速入门（三）- goroutine | Kaisco L</title>
    <meta name="description" content="Rome is not built in a day.">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.0ad23782.css" as="style"><link rel="preload" href="/assets/js/app.eb766794.js" as="script"><link rel="preload" href="/assets/js/2.12a3889d.js" as="script"><link rel="preload" href="/assets/js/10.3e3aa79e.js" as="script"><link rel="prefetch" href="/assets/js/11.e54a9576.js"><link rel="prefetch" href="/assets/js/12.15fba913.js"><link rel="prefetch" href="/assets/js/13.e62a5e25.js"><link rel="prefetch" href="/assets/js/14.7f590dff.js"><link rel="prefetch" href="/assets/js/15.da3f9779.js"><link rel="prefetch" href="/assets/js/16.62dc4f1a.js"><link rel="prefetch" href="/assets/js/3.4d6c77a2.js"><link rel="prefetch" href="/assets/js/4.9fb4c202.js"><link rel="prefetch" href="/assets/js/5.a9f8dc60.js"><link rel="prefetch" href="/assets/js/6.acbbc17d.js"><link rel="prefetch" href="/assets/js/7.bc0929d5.js"><link rel="prefetch" href="/assets/js/8.61479e54.js"><link rel="prefetch" href="/assets/js/9.f2d3f225.js">
    <link rel="stylesheet" href="/assets/css/0.styles.0ad23782.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Kaisco L</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/contents.html" class="nav-link">Contents</a></div><div class="nav-item"><a href="https://github.com/kaisco" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/contents.html" class="nav-link">Contents</a></div><div class="nav-item"><a href="https://github.com/kaisco" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Go 快速入门（三）- goroutine</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-golang/03.html#本章学习目标" class="sidebar-link">本章学习目标</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/learn-golang/03.html#一、什么是goroutine" class="sidebar-link">一、什么是goroutine</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/learn-golang/03.html#_1、进程与线程" class="sidebar-link">1、进程与线程</a></li><li class="sidebar-sub-header"><a href="/learn-golang/03.html#_2、goroutine就是协程" class="sidebar-link">2、goroutine就是协程?</a></li></ul></li><li><a href="/learn-golang/03.html#二、goroutine调度机制" class="sidebar-link">二、goroutine调度机制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/learn-golang/03.html#_1、g-goroutine" class="sidebar-link">1、G (goroutine)</a></li><li class="sidebar-sub-header"><a href="/learn-golang/03.html#_2、m-machine" class="sidebar-link">2、M (machine)</a></li><li class="sidebar-sub-header"><a href="/learn-golang/03.html#_3、p-process" class="sidebar-link">3、P (process)</a></li><li class="sidebar-sub-header"><a href="/learn-golang/03.html#_4、调度流程" class="sidebar-link">4、调度流程</a></li></ul></li><li><a href="/learn-golang/03.html#三、goroutine使用" class="sidebar-link">三、goroutine使用</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="go-快速入门（三）-goroutine"><a href="#go-快速入门（三）-goroutine" class="header-anchor">#</a> Go 快速入门（三）- goroutine</h1> <h2 id="本章学习目标"><a href="#本章学习目标" class="header-anchor">#</a> 本章学习目标</h2> <p><code>go</code>语言有着较高的开发效率，提供了海量并行的支持。听说过<code>go</code>语言的小伙伴应该都听说过这些特性。我们已经在前面章节体验到了使用<code>go</code>语言开发的便捷性。这一章节，我们来了解<code>go</code>语言并发利器<code>goroutine</code>。</p> <h2 id="一、什么是goroutine"><a href="#一、什么是goroutine" class="header-anchor">#</a> 一、什么是goroutine</h2> <p>在了解<code>goroutine</code>之前，我们先简单了解一下进程与线程。</p> <h3 id="_1、进程与线程"><a href="#_1、进程与线程" class="header-anchor">#</a> 1、进程与线程</h3> <p>进程是资源分配的最小单位，线程是程序执行的最小单位。</p> <p>进程有自己的独立地址空间，每启动一个进程，系统就会为它分配地址空间，建立数据表来维护代码段、堆栈段和数据段，这种系统操作非常昂贵。而线程是共享进程中的数据的，使用相同的地址空间，因此CPU切换一个线程的花费远比进程要小很多，同时创建一个线程的开销也比进程要小很多。</p> <p>直白地讲，进程就是应用程序的启动实例。比如我们运行一个游戏，打开一个软件，就是开启了一个进程。进程拥有代码和打开的文件资源、数据资源、独立的内存空间。线程从属于进程，是程序的实际执行者。一个进程至少包含一个主线程，也可以有更多的子线程。</p> <p>这儿有一篇能够让大家形象理解进程与线程关系的文章（<a href="http://www.ruanyifeng.com/blog/2013/04/processes_and_threads.html" target="_blank" rel="noopener noreferrer">进程与线程的一个简单解释<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>），更多进程、线程知识大家自行了解啦。</p> <h3 id="_2、goroutine就是协程"><a href="#_2、goroutine就是协程" class="header-anchor">#</a> 2、goroutine就是协程?</h3> <p>我们先来看看什么是协程。</p> <p>协程（<code>coroutines</code>）是一种协作任务控制机制，是一种比线程更加轻量级的存在。最重要的是，协程不是被操作系统内核所管理，而完全是由程序所控制（也就是在用户态执行）。协程的概念提出时间其实比线程还要早，不过是这几年才被大家熟知。</p> <p>用生产者/消费者模式举例。创建一个消费者协程，并且在主线程中生产数据，协程中消费数据。当协程执行到需要生产数据地方时会暂停，等到主线程生产数据后，协程才会接到数据继续执行。但是，协程暂停和线程的阻塞是有本质区别的。协程的暂停完全由程序控制，线程的阻塞状态是由操作系统内核来进行切换。</p> <p>本质上，<code>goroutine</code> 就是协程。 不同的是，<code>go</code>在 runtime、系统调用等多方面对<code>goroutine</code>调度进行了封装和处理，当遇到长时间执行或者进行系统调用时，会主动把当前 <code>goroutine</code>的CPU (P) 转让出去，让其他 <code>goroutine</code> 能被调度并执行，也就是 <code>go</code> 从语言层面支持了协程。</p> <p>个人理解，<code>goroutine</code>实现了协程（<code>coroutines</code>）这一协作任务控制机制。</p> <h2 id="二、goroutine调度机制"><a href="#二、goroutine调度机制" class="header-anchor">#</a> 二、goroutine调度机制</h2> <p>要理解协程的实现,，首先需要了解go中的三个非常重要的概念，它们分别是<strong>G</strong>、 <strong>M</strong>和<strong>P</strong>。这三项是协程最主要的组成部分， 它们在<code>go</code>的源代码中无处不在。</p> <h3 id="_1、g-goroutine"><a href="#_1、g-goroutine" class="header-anchor">#</a> 1、G (goroutine)</h3> <p>G是<code>goroutine</code>的首字母，<code>goroutine</code>可以解释为受管理的轻量线程，<code>goroutine</code>使用<code>go</code>关键词创建。存储了<code>goroutine</code>的执行stack信息、<code>goroutine</code>状态以及<code>goroutine</code>的任务函数等；</p> <h3 id="_2、m-machine"><a href="#_2、m-machine" class="header-anchor">#</a> 2、M (machine)</h3> <p>M是machine的首字母，基本<strong>等同于系统线程</strong>。M会从运行队列中取出G， 然后运行G， 如果G运行完毕或者进入休眠状态，则从运行队列中取出下一个G运行， 周而复始。</p> <h3 id="_3、p-process"><a href="#_3、p-process" class="header-anchor">#</a> 3、P (process)</h3> <p>P是<code>process</code>的首字母，代表逻辑处理器。即M运行G所需要的资源。P也可以理解为控制<code>go</code>代码的并行度的机制。P的数量决定了系统内最大可并行的G的数量（前提：系统的物理cpu核数&gt;=P的数量）。</p> <h3 id="_4、调度流程"><a href="#_4、调度流程" class="header-anchor">#</a> 4、调度流程</h3> <p>当通过<code>go</code>关键字创建一个新的<code>goroutine</code>的时候，它会优先被放入P的本地队列。为了运行<code>goroutine</code>，M需要持有（绑定）一个P，接着M会启动一个OS线程，循环从P的本地队列里取出一个<code>goroutine</code>并执行。</p> <p>上面介绍的<code>goroutine</code>调度流程只是简化版流程。<code>work-stealing</code>调度算法、<code>goroutine</code>的阻塞/唤醒、系统调用阻塞、大规模<code>goroutine</code>瓶颈等等问题都是<code>goroutine</code>调度过程中具体问题。欢迎感兴趣的小伙伴们一起来探讨。</p> <h2 id="三、goroutine使用"><a href="#三、goroutine使用" class="header-anchor">#</a> 三、goroutine使用</h2> <p><code>goroutine</code>是Go并行设计的核心。<code>goroutine</code>说到底其实就是线程，但是它比线程更小，十几个<code>goroutine</code>可能体现在底层就是五六个线程，Go语言内部帮我们实现了这些<code>goroutine</code>之间的内存共享。执行<code>goroutine</code>只需极少的栈内存。也正因为如此，可同时运行成千上万个并发任务。<code>goroutine</code>比线程更易用、更高效、更轻便。</p> <p><code>goroutine</code>是通过<code>go</code>的runtime管理的一个线程管理器。<code>goroutine</code>通过<code>go</code>关键字实现了，其实就是一个普通的函数。</p> <div class="language- extra-class"><pre class="language-text"><code>go hello(a, b, c)
</code></pre></div><p>通过关键字go就启动了一个goroutine。我们来看一个例子</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;fmt&quot;</span>
    <span class="token string">&quot;runtime&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">say</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        runtime<span class="token punctuation">.</span><span class="token function">Gosched</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// CPU把时间片让给别人,下次某个时候继续恢复执行该goroutine</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">go</span> <span class="token function">say</span><span class="token punctuation">(</span><span class="token string">&quot;world&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 开一个新的Goroutines执行</span>
    <span class="token function">say</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 当前Goroutines执行</span>
<span class="token punctuation">}</span>

<span class="token comment">// 以上程序执行后将输出：</span>
<span class="token comment">// hello</span>
<span class="token comment">// world</span>
<span class="token comment">// hello</span>
<span class="token comment">// world</span>
<span class="token comment">// hello</span>
<span class="token comment">// world</span>
<span class="token comment">// hello</span>
<span class="token comment">// world</span>
<span class="token comment">// hello</span>
</code></pre></div><p>我们可以看到<code>go</code>关键字很方便的就实现了并发编程。 上面的多个<code>goroutine</code>运行在同一个进程里面，共享内存数据，不过设计上我们要遵循：不通过共享来通信，而要通过通信来共享。后面章节我们会讲解如何通过通信来共享 。</p> <h1 id="本章试练"><a href="#本章试练" class="header-anchor">#</a> 本章试练</h1> <ul><li><a href="https://tour.go-zh.org/concurrency/10" target="_blank" rel="noopener noreferrer">使用 Go 的并发特性来实现一个 Web 爬虫<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.eb766794.js" defer></script><script src="/assets/js/2.12a3889d.js" defer></script><script src="/assets/js/10.3e3aa79e.js" defer></script>
  </body>
</html>
