<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Go快速入门（四）- 实战训练营 | Kaisco L</title>
    <meta name="description" content="Rome is not built in a day.">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.0ad23782.css" as="style"><link rel="preload" href="/assets/js/app.eb766794.js" as="script"><link rel="preload" href="/assets/js/2.12a3889d.js" as="script"><link rel="preload" href="/assets/js/11.e54a9576.js" as="script"><link rel="prefetch" href="/assets/js/10.3e3aa79e.js"><link rel="prefetch" href="/assets/js/12.15fba913.js"><link rel="prefetch" href="/assets/js/13.e62a5e25.js"><link rel="prefetch" href="/assets/js/14.7f590dff.js"><link rel="prefetch" href="/assets/js/15.da3f9779.js"><link rel="prefetch" href="/assets/js/16.62dc4f1a.js"><link rel="prefetch" href="/assets/js/3.4d6c77a2.js"><link rel="prefetch" href="/assets/js/4.9fb4c202.js"><link rel="prefetch" href="/assets/js/5.a9f8dc60.js"><link rel="prefetch" href="/assets/js/6.acbbc17d.js"><link rel="prefetch" href="/assets/js/7.bc0929d5.js"><link rel="prefetch" href="/assets/js/8.61479e54.js"><link rel="prefetch" href="/assets/js/9.f2d3f225.js">
    <link rel="stylesheet" href="/assets/css/0.styles.0ad23782.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Kaisco L</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/contents.html" class="nav-link">Contents</a></div><div class="nav-item"><a href="https://github.com/kaisco" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/contents.html" class="nav-link">Contents</a></div><div class="nav-item"><a href="https://github.com/kaisco" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Go快速入门（四）- 实战训练营</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-golang/04.html#本章学习目标" class="sidebar-link">本章学习目标</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/learn-golang/04.html#web-爬虫实战" class="sidebar-link">Web 爬虫实战</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/learn-golang/04.html#_1、需求分析" class="sidebar-link">1、需求分析</a></li><li class="sidebar-sub-header"><a href="/learn-golang/04.html#_2、实现思路" class="sidebar-link">2、实现思路</a></li><li class="sidebar-sub-header"><a href="/learn-golang/04.html#_3、习题分析" class="sidebar-link">3、习题分析</a></li><li class="sidebar-sub-header"><a href="/learn-golang/04.html#_4、sync包" class="sidebar-link">4、sync包</a></li><li class="sidebar-sub-header"><a href="/learn-golang/04.html#_5、解题" class="sidebar-link">5、解题</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="go快速入门（四）-实战训练营"><a href="#go快速入门（四）-实战训练营" class="header-anchor">#</a> Go快速入门（四）- 实战训练营</h1> <h2 id="本章学习目标"><a href="#本章学习目标" class="header-anchor">#</a> 本章学习目标</h2> <p>在前几章节夯实基础的下，原本兴趣十足的小伙伴们都跃(mei)跃(you)欲(xing)试(qu)了。那今天这个章节我们就抛开语言的条条款款，来实战一番。</p> <h2 id="web-爬虫实战"><a href="#web-爬虫实战" class="header-anchor">#</a> Web 爬虫实战</h2> <p>上一个章节末尾留下一道练习题目，不知道大家完成得怎么样了呢？</p> <p>嗯？题目？什么题目？我怎么没有看到呢？</p> <p>好吧，我知道大家根本没有看啦。那本章节我们来看看这到题目怎么完成。</p> <h3 id="_1、需求分析"><a href="#_1、需求分析" class="header-anchor">#</a> 1、需求分析</h3> <p>用爬虫进行Web数据挖掘已经越来越普遍，最常见的是对于网站内容的爬取，包括文本、图片和文件等；其次对于网站结构的爬取，包括网站目录、链接之间的相互跳转关系、二级域名等；还有一种爬虫是对于Web应用数据的挖掘。</p> <p>既然爬虫如此重要还如此好玩，那我们来看看如何使用<code>go</code>语言实现爬虫吧。</p> <h3 id="_2、实现思路"><a href="#_2、实现思路" class="header-anchor">#</a> 2、实现思路</h3> <p>爬虫，就是获取从Web页面内容的数据和URL，然后再从获取URL相对应页面内容的数据和URL。从一个Web页面出发像蜘蛛网一样发散开来。</p> <p>因此，如何实现一个爬虫程序，关键点是如何从一个Web页面获取该页面下的URL。另一个关键点则是如何并发地抓取Web页面内容。使用<code>go</code>语言<code>http</code>获取网页内容（暂时不涉及），使用<code>goroutine</code>并发抓取网页，so easy！</p> <h3 id="_3、习题分析"><a href="#_3、习题分析" class="header-anchor">#</a> 3、习题分析</h3> <p>点开题目链接<a href="https://tour.go-zh.org/concurrency/10" target="_blank" rel="noopener noreferrer"> Go 的并发特性来实现一个 Web 爬虫<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。能看到题目中已经写了很多代码啦。那我们来分析一下这些代码目的是什么。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// 7~10行</span>
<span class="token keyword">type</span> Fetcher <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token comment">// Fetch 返回 URL 的 body 内容，并且将在这个页面上找到的 URL 放到一个 slice 中。</span>
	<span class="token function">Fetch</span><span class="token punctuation">(</span>url <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>body <span class="token builtin">string</span><span class="token punctuation">,</span> urls <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 44-49行</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f fakeFetcher<span class="token punctuation">)</span> <span class="token function">Fetch</span><span class="token punctuation">(</span>url <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> res<span class="token punctuation">,</span> ok <span class="token operator">:=</span> f<span class="token punctuation">[</span>url<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		<span class="token keyword">return</span> res<span class="token punctuation">.</span>body<span class="token punctuation">,</span> res<span class="token punctuation">.</span>urls<span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;not found: %s&quot;</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个不就是第二章节中的<code>interface</code>接口嘛，而且<code>fakeFetcher</code>实现了接口<code>Fetcher</code>的<code>Fetch</code>方法。那我们再看看结构体<code>fakeFetcher</code>。等等fake fetcher？假的抓取者？</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// 36-42行</span>
<span class="token comment">// fakeFetcher 是返回若干结果的 Fetcher。</span>
<span class="token keyword">type</span> fakeFetcher <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>fakeResult

<span class="token keyword">type</span> fakeResult <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	body <span class="token builtin">string</span>
	urls <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
<span class="token punctuation">}</span>
</code></pre></div><p>结构体<code>fakeResult</code> ，就是爬虫抓取URL网页的内容body和body中的很多URL。但是为什么是又是fake呢?</p> <p><code>type fakeFetcher map[string]*fakeResult</code>这个好像看不懂啊，<code>type</code>是定义类型的关键字，难道是定义了一个<code>map[string]*fakeResult</code>的<code>fakeFetcher</code>类型？</p> <p>为什么这么多问题啊，再看看题目吧。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// 51-83行</span>
<span class="token comment">// fetcher 是填充后的 fakeFetcher。</span>
<span class="token keyword">var</span> fetcher <span class="token operator">=</span> fakeFetcher<span class="token punctuation">{</span>
	<span class="token string">&quot;https://golang.org/&quot;</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span>fakeResult<span class="token punctuation">{</span>
		<span class="token string">&quot;The Go Programming Language&quot;</span><span class="token punctuation">,</span>
		<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
			<span class="token string">&quot;https://golang.org/pkg/&quot;</span><span class="token punctuation">,</span>
			<span class="token string">&quot;https://golang.org/cmd/&quot;</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token string">&quot;https://golang.org/pkg/&quot;</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span>fakeResult<span class="token punctuation">{</span>
		<span class="token string">&quot;Packages&quot;</span><span class="token punctuation">,</span>
		<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
			<span class="token string">&quot;https://golang.org/&quot;</span><span class="token punctuation">,</span>
			<span class="token string">&quot;https://golang.org/cmd/&quot;</span><span class="token punctuation">,</span>
			<span class="token string">&quot;https://golang.org/pkg/fmt/&quot;</span><span class="token punctuation">,</span>
			<span class="token string">&quot;https://golang.org/pkg/os/&quot;</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token string">&quot;https://golang.org/pkg/fmt/&quot;</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span>fakeResult<span class="token punctuation">{</span>
		<span class="token string">&quot;Package fmt&quot;</span><span class="token punctuation">,</span>
		<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
			<span class="token string">&quot;https://golang.org/&quot;</span><span class="token punctuation">,</span>
			<span class="token string">&quot;https://golang.org/pkg/&quot;</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token string">&quot;https://golang.org/pkg/os/&quot;</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span>fakeResult<span class="token punctuation">{</span>
		<span class="token string">&quot;Package os&quot;</span><span class="token punctuation">,</span>
		<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
			<span class="token string">&quot;https://golang.org/&quot;</span><span class="token punctuation">,</span>
			<span class="token string">&quot;https://golang.org/pkg/&quot;</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>var fetcher = fakeFetcher{…}</code>，定义一个变量类型为<code>fakeFetcher</code>，果然<code>fakeFetcher</code>是自定义的类型。再看赋值内容，<code>fakeResult</code>结构体系属性body、urls都相应地被赋值了。想到<code>Fetcher</code>被<code>fakeFetcher</code>实现的方法直接返回的是<code>fakeFetcher</code>下<code>fakeResult</code>的body、urls。</p> <blockquote><p><em>提示</em>：你可以用一个 map 来缓存已经获取的 URL，但是要注意 map 本身并不是并发安全的！</p></blockquote> <p>看到题目提示<code>map 本身并不是并发安全</code>（至于为什么不是并发安全，大家可以了解一下Map的实现原理），那么如何才能使用map并发完全呢？大家都知道，在多线程访问共享内存时也不是并发安全的。那么map也可以使用互斥锁的方式让其并发安全。</p> <h3 id="_4、sync包"><a href="#_4、sync包" class="header-anchor">#</a> 4、sync包</h3> <ul><li><p>互斥锁 Mutex</p> <p>一个互斥锁只能同时被一个 <code>goroutine</code>锁定，其它 <code>goroutine</code> 将阻塞直到互斥锁被解锁。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Mutex<span class="token punctuation">)</span> <span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">// 上锁</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Mutex<span class="token punctuation">)</span> <span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 解锁</span>
</code></pre></div></li> <li><p>WaitGroup</p> <p><code>WaitGroup</code>用于等待一组 <code>goroutine</code> 结束。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>wg <span class="token operator">*</span>WaitGroup<span class="token punctuation">)</span> <span class="token function">Add</span><span class="token punctuation">(</span>delta <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token comment">// 添加deltaw个goroutine</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>wg <span class="token operator">*</span>WaitGroup<span class="token punctuation">)</span> <span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>			<span class="token comment">// 添加减少1个goroutine</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>wg <span class="token operator">*</span>WaitGroup<span class="token punctuation">)</span> <span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>			<span class="token comment">// 等待goroutine执行完成</span>
</code></pre></div><p>sync包下的<code>Mutex</code>与<code>WaitGroup</code>将会在下面爬虫的实现中用到。</p></li></ul> <h3 id="_5、解题"><a href="#_5、解题" class="header-anchor">#</a> 5、解题</h3> <p>从上面的分析可以知道，这道题只用写并发逻辑不用真实抓取网页内容。<code>fakeResult</code>表示假的抓取网页内容，<code>fakeFetcher</code>表示假的抓取的网页结构。只用实现并发情况下抓取网页，并且使用map记录下已经抓取过的URL。</p> <p>首先，我们定义一个已经抓取过网页的结构。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> Fetched <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	m <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">error</span>
	sync<span class="token punctuation">.</span>Mutex <span class="token comment">// 互斥锁、匿名结构体</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> fetched <span class="token operator">=</span> Fetched<span class="token punctuation">{</span>m<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">error</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
</code></pre></div><p>然后，修改Crawl函数。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Crawl</span><span class="token punctuation">(</span>url <span class="token builtin">string</span><span class="token punctuation">,</span> depth <span class="token builtin">int</span><span class="token punctuation">,</span> fetcher Fetcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> depth <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 判断url是否被抓取过</span>
	fetched<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> fetched<span class="token punctuation">.</span>m<span class="token punctuation">[</span>url<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		fetched<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	fetched<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	body<span class="token punctuation">,</span> urls<span class="token punctuation">,</span> err <span class="token operator">:=</span> fetcher<span class="token punctuation">.</span><span class="token function">Fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
	<span class="token comment">// 记录抓取当前url结果</span>
	fetched<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fetched<span class="token punctuation">.</span>m<span class="token punctuation">[</span>url<span class="token punctuation">]</span> <span class="token operator">=</span> err
	fetched<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;found: %s %q\n&quot;</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> body<span class="token punctuation">)</span>

	<span class="token comment">// 使用goroutine循环抓取urls,使用sync.WaitGroup来等待当抓取到的urls被抓取完</span>
	<span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> u <span class="token operator">:=</span> <span class="token keyword">range</span> urls <span class="token punctuation">{</span>
		wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>wg <span class="token operator">*</span>sync<span class="token punctuation">.</span>WaitGroup<span class="token punctuation">,</span> url <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">Crawl</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> depth<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> fetcher<span class="token punctuation">)</span>
			wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wg<span class="token punctuation">,</span> u<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre></div><p>最后，在main函数中打印已经被抓取的结果。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;sync&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Fetched <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	m          <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">error</span>
	sync<span class="token punctuation">.</span>Mutex <span class="token comment">// 互斥锁、匿名结构体</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> fetched <span class="token operator">=</span> Fetched<span class="token punctuation">{</span>m<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">error</span><span class="token punctuation">)</span><span class="token punctuation">}</span>

<span class="token keyword">type</span> Fetcher <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token comment">// Fetch 返回 URL 的 body 内容，并且将在这个页面上找到的 URL 放到一个 slice 中。</span>
	<span class="token function">Fetch</span><span class="token punctuation">(</span>url <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>body <span class="token builtin">string</span><span class="token punctuation">,</span> urls <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Crawl 使用 fetcher 从某个 URL 开始递归的爬取页面，直到达到最大深度。</span>
<span class="token keyword">func</span> <span class="token function">Crawl</span><span class="token punctuation">(</span>url <span class="token builtin">string</span><span class="token punctuation">,</span> depth <span class="token builtin">int</span><span class="token punctuation">,</span> fetcher Fetcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> depth <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 判断url是否被抓取过</span>
	fetched<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> fetched<span class="token punctuation">.</span>m<span class="token punctuation">[</span>url<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		fetched<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	fetched<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	body<span class="token punctuation">,</span> urls<span class="token punctuation">,</span> err <span class="token operator">:=</span> fetcher<span class="token punctuation">.</span><span class="token function">Fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
	<span class="token comment">// 记录抓取当前url结果</span>
	fetched<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fetched<span class="token punctuation">.</span>m<span class="token punctuation">[</span>url<span class="token punctuation">]</span> <span class="token operator">=</span> err
	fetched<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;found: %s %q\n&quot;</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> body<span class="token punctuation">)</span>

	<span class="token comment">// 使用goroutine循环抓取urls,使用sync.WaitGroup来等待当抓取到的urls被抓取完</span>
	<span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> u <span class="token operator">:=</span> <span class="token keyword">range</span> urls <span class="token punctuation">{</span>
		wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>wg <span class="token operator">*</span>sync<span class="token punctuation">.</span>WaitGroup<span class="token punctuation">,</span> url <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">Crawl</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> depth<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> fetcher<span class="token punctuation">)</span>
			wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wg<span class="token punctuation">,</span> u<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">Crawl</span><span class="token punctuation">(</span><span class="token string">&quot;https://golang.org/&quot;</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> fetcher<span class="token punctuation">)</span>

	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Fetching stats\n--------------&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> url<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token keyword">range</span> fetched<span class="token punctuation">.</span>m <span class="token punctuation">{</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%v failed: %v\n&quot;</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%v was fetched\n&quot;</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// fakeFetcher 是返回若干结果的 Fetcher。</span>
<span class="token keyword">type</span> fakeFetcher <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>fakeResult

<span class="token keyword">type</span> fakeResult <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	body <span class="token builtin">string</span>
	urls <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>f fakeFetcher<span class="token punctuation">)</span> <span class="token function">Fetch</span><span class="token punctuation">(</span>url <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> res<span class="token punctuation">,</span> ok <span class="token operator">:=</span> f<span class="token punctuation">[</span>url<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		<span class="token keyword">return</span> res<span class="token punctuation">.</span>body<span class="token punctuation">,</span> res<span class="token punctuation">.</span>urls<span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;not found: %s&quot;</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// fetcher 是填充后的 fakeFetcher。</span>
<span class="token keyword">var</span> fetcher <span class="token operator">=</span> fakeFetcher<span class="token punctuation">{</span>
	<span class="token string">&quot;https://golang.org/&quot;</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span>fakeResult<span class="token punctuation">{</span>
		<span class="token string">&quot;The Go Programming Language&quot;</span><span class="token punctuation">,</span>
		<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
			<span class="token string">&quot;https://golang.org/pkg/&quot;</span><span class="token punctuation">,</span>
			<span class="token string">&quot;https://golang.org/cmd/&quot;</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token string">&quot;https://golang.org/pkg/&quot;</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span>fakeResult<span class="token punctuation">{</span>
		<span class="token string">&quot;Packages&quot;</span><span class="token punctuation">,</span>
		<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
			<span class="token string">&quot;https://golang.org/&quot;</span><span class="token punctuation">,</span>
			<span class="token string">&quot;https://golang.org/cmd/&quot;</span><span class="token punctuation">,</span>
			<span class="token string">&quot;https://golang.org/pkg/fmt/&quot;</span><span class="token punctuation">,</span>
			<span class="token string">&quot;https://golang.org/pkg/os/&quot;</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token string">&quot;https://golang.org/pkg/fmt/&quot;</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span>fakeResult<span class="token punctuation">{</span>
		<span class="token string">&quot;Package fmt&quot;</span><span class="token punctuation">,</span>
		<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
			<span class="token string">&quot;https://golang.org/&quot;</span><span class="token punctuation">,</span>
			<span class="token string">&quot;https://golang.org/pkg/&quot;</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token string">&quot;https://golang.org/pkg/os/&quot;</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span>fakeResult<span class="token punctuation">{</span>
		<span class="token string">&quot;Package os&quot;</span><span class="token punctuation">,</span>
		<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
			<span class="token string">&quot;https://golang.org/&quot;</span><span class="token punctuation">,</span>
			<span class="token string">&quot;https://golang.org/pkg/&quot;</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>那么这道题目就正式完成啦，其实上面的实现方法中使用<code>WaitGroup</code>会等待一组<code>goroutine</code>执行完成后才能结束。我们能不能让<code>goroutine</code>执行完成后不让调用函数等待呢？当然可以，这就是下一章节<code>channel</code>的内容，敬请期待。</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.eb766794.js" defer></script><script src="/assets/js/2.12a3889d.js" defer></script><script src="/assets/js/11.e54a9576.js" defer></script>
  </body>
</html>
